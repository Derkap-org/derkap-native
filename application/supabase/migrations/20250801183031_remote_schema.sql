revoke delete on table "public"."app_ maintenance" from "anon";

revoke insert on table "public"."app_ maintenance" from "anon";

revoke references on table "public"."app_ maintenance" from "anon";

revoke select on table "public"."app_ maintenance" from "anon";

revoke trigger on table "public"."app_ maintenance" from "anon";

revoke truncate on table "public"."app_ maintenance" from "anon";

revoke update on table "public"."app_ maintenance" from "anon";

revoke delete on table "public"."app_ maintenance" from "authenticated";

revoke insert on table "public"."app_ maintenance" from "authenticated";

revoke references on table "public"."app_ maintenance" from "authenticated";

revoke select on table "public"."app_ maintenance" from "authenticated";

revoke trigger on table "public"."app_ maintenance" from "authenticated";

revoke truncate on table "public"."app_ maintenance" from "authenticated";

revoke update on table "public"."app_ maintenance" from "authenticated";

revoke delete on table "public"."app_ maintenance" from "service_role";

revoke insert on table "public"."app_ maintenance" from "service_role";

revoke references on table "public"."app_ maintenance" from "service_role";

revoke select on table "public"."app_ maintenance" from "service_role";

revoke trigger on table "public"."app_ maintenance" from "service_role";

revoke truncate on table "public"."app_ maintenance" from "service_role";

revoke update on table "public"."app_ maintenance" from "service_role";

revoke delete on table "public"."app_feedback" from "anon";

revoke insert on table "public"."app_feedback" from "anon";

revoke references on table "public"."app_feedback" from "anon";

revoke select on table "public"."app_feedback" from "anon";

revoke trigger on table "public"."app_feedback" from "anon";

revoke truncate on table "public"."app_feedback" from "anon";

revoke update on table "public"."app_feedback" from "anon";

revoke delete on table "public"."app_feedback" from "authenticated";

revoke insert on table "public"."app_feedback" from "authenticated";

revoke references on table "public"."app_feedback" from "authenticated";

revoke select on table "public"."app_feedback" from "authenticated";

revoke trigger on table "public"."app_feedback" from "authenticated";

revoke truncate on table "public"."app_feedback" from "authenticated";

revoke update on table "public"."app_feedback" from "authenticated";

revoke delete on table "public"."app_feedback" from "service_role";

revoke insert on table "public"."app_feedback" from "service_role";

revoke references on table "public"."app_feedback" from "service_role";

revoke select on table "public"."app_feedback" from "service_role";

revoke trigger on table "public"."app_feedback" from "service_role";

revoke truncate on table "public"."app_feedback" from "service_role";

revoke update on table "public"."app_feedback" from "service_role";

revoke delete on table "public"."app_version" from "anon";

revoke insert on table "public"."app_version" from "anon";

revoke references on table "public"."app_version" from "anon";

revoke select on table "public"."app_version" from "anon";

revoke trigger on table "public"."app_version" from "anon";

revoke truncate on table "public"."app_version" from "anon";

revoke update on table "public"."app_version" from "anon";

revoke delete on table "public"."app_version" from "authenticated";

revoke insert on table "public"."app_version" from "authenticated";

revoke references on table "public"."app_version" from "authenticated";

revoke select on table "public"."app_version" from "authenticated";

revoke trigger on table "public"."app_version" from "authenticated";

revoke truncate on table "public"."app_version" from "authenticated";

revoke update on table "public"."app_version" from "authenticated";

revoke delete on table "public"."app_version" from "service_role";

revoke insert on table "public"."app_version" from "service_role";

revoke references on table "public"."app_version" from "service_role";

revoke select on table "public"."app_version" from "service_role";

revoke trigger on table "public"."app_version" from "service_role";

revoke truncate on table "public"."app_version" from "service_role";

revoke update on table "public"."app_version" from "service_role";

revoke delete on table "public"."challenge" from "anon";

revoke insert on table "public"."challenge" from "anon";

revoke references on table "public"."challenge" from "anon";

revoke select on table "public"."challenge" from "anon";

revoke trigger on table "public"."challenge" from "anon";

revoke truncate on table "public"."challenge" from "anon";

revoke update on table "public"."challenge" from "anon";

revoke delete on table "public"."challenge" from "authenticated";

revoke insert on table "public"."challenge" from "authenticated";

revoke references on table "public"."challenge" from "authenticated";

revoke select on table "public"."challenge" from "authenticated";

revoke trigger on table "public"."challenge" from "authenticated";

revoke truncate on table "public"."challenge" from "authenticated";

revoke update on table "public"."challenge" from "authenticated";

revoke delete on table "public"."challenge" from "service_role";

revoke insert on table "public"."challenge" from "service_role";

revoke references on table "public"."challenge" from "service_role";

revoke select on table "public"."challenge" from "service_role";

revoke trigger on table "public"."challenge" from "service_role";

revoke truncate on table "public"."challenge" from "service_role";

revoke update on table "public"."challenge" from "service_role";

revoke delete on table "public"."comment" from "anon";

revoke insert on table "public"."comment" from "anon";

revoke references on table "public"."comment" from "anon";

revoke select on table "public"."comment" from "anon";

revoke trigger on table "public"."comment" from "anon";

revoke truncate on table "public"."comment" from "anon";

revoke update on table "public"."comment" from "anon";

revoke delete on table "public"."comment" from "authenticated";

revoke insert on table "public"."comment" from "authenticated";

revoke references on table "public"."comment" from "authenticated";

revoke select on table "public"."comment" from "authenticated";

revoke trigger on table "public"."comment" from "authenticated";

revoke truncate on table "public"."comment" from "authenticated";

revoke update on table "public"."comment" from "authenticated";

revoke delete on table "public"."comment" from "service_role";

revoke insert on table "public"."comment" from "service_role";

revoke references on table "public"."comment" from "service_role";

revoke select on table "public"."comment" from "service_role";

revoke trigger on table "public"."comment" from "service_role";

revoke truncate on table "public"."comment" from "service_role";

revoke update on table "public"."comment" from "service_role";

revoke delete on table "public"."delete_account" from "anon";

revoke insert on table "public"."delete_account" from "anon";

revoke references on table "public"."delete_account" from "anon";

revoke select on table "public"."delete_account" from "anon";

revoke trigger on table "public"."delete_account" from "anon";

revoke truncate on table "public"."delete_account" from "anon";

revoke update on table "public"."delete_account" from "anon";

revoke delete on table "public"."delete_account" from "authenticated";

revoke insert on table "public"."delete_account" from "authenticated";

revoke references on table "public"."delete_account" from "authenticated";

revoke select on table "public"."delete_account" from "authenticated";

revoke trigger on table "public"."delete_account" from "authenticated";

revoke truncate on table "public"."delete_account" from "authenticated";

revoke update on table "public"."delete_account" from "authenticated";

revoke delete on table "public"."delete_account" from "service_role";

revoke insert on table "public"."delete_account" from "service_role";

revoke references on table "public"."delete_account" from "service_role";

revoke select on table "public"."delete_account" from "service_role";

revoke trigger on table "public"."delete_account" from "service_role";

revoke truncate on table "public"."delete_account" from "service_role";

revoke update on table "public"."delete_account" from "service_role";

revoke delete on table "public"."derkap" from "anon";

revoke insert on table "public"."derkap" from "anon";

revoke references on table "public"."derkap" from "anon";

revoke select on table "public"."derkap" from "anon";

revoke trigger on table "public"."derkap" from "anon";

revoke truncate on table "public"."derkap" from "anon";

revoke update on table "public"."derkap" from "anon";

revoke delete on table "public"."derkap" from "authenticated";

revoke insert on table "public"."derkap" from "authenticated";

revoke references on table "public"."derkap" from "authenticated";

revoke select on table "public"."derkap" from "authenticated";

revoke trigger on table "public"."derkap" from "authenticated";

revoke truncate on table "public"."derkap" from "authenticated";

revoke update on table "public"."derkap" from "authenticated";

revoke delete on table "public"."derkap" from "service_role";

revoke insert on table "public"."derkap" from "service_role";

revoke references on table "public"."derkap" from "service_role";

revoke select on table "public"."derkap" from "service_role";

revoke trigger on table "public"."derkap" from "service_role";

revoke truncate on table "public"."derkap" from "service_role";

revoke update on table "public"."derkap" from "service_role";

revoke delete on table "public"."derkap_allowed_users" from "anon";

revoke insert on table "public"."derkap_allowed_users" from "anon";

revoke references on table "public"."derkap_allowed_users" from "anon";

revoke select on table "public"."derkap_allowed_users" from "anon";

revoke trigger on table "public"."derkap_allowed_users" from "anon";

revoke truncate on table "public"."derkap_allowed_users" from "anon";

revoke update on table "public"."derkap_allowed_users" from "anon";

revoke delete on table "public"."derkap_allowed_users" from "authenticated";

revoke insert on table "public"."derkap_allowed_users" from "authenticated";

revoke references on table "public"."derkap_allowed_users" from "authenticated";

revoke select on table "public"."derkap_allowed_users" from "authenticated";

revoke trigger on table "public"."derkap_allowed_users" from "authenticated";

revoke truncate on table "public"."derkap_allowed_users" from "authenticated";

revoke update on table "public"."derkap_allowed_users" from "authenticated";

revoke delete on table "public"."derkap_allowed_users" from "service_role";

revoke insert on table "public"."derkap_allowed_users" from "service_role";

revoke references on table "public"."derkap_allowed_users" from "service_role";

revoke select on table "public"."derkap_allowed_users" from "service_role";

revoke trigger on table "public"."derkap_allowed_users" from "service_role";

revoke truncate on table "public"."derkap_allowed_users" from "service_role";

revoke update on table "public"."derkap_allowed_users" from "service_role";

revoke delete on table "public"."friends_request" from "anon";

revoke insert on table "public"."friends_request" from "anon";

revoke references on table "public"."friends_request" from "anon";

revoke select on table "public"."friends_request" from "anon";

revoke trigger on table "public"."friends_request" from "anon";

revoke truncate on table "public"."friends_request" from "anon";

revoke update on table "public"."friends_request" from "anon";

revoke delete on table "public"."friends_request" from "authenticated";

revoke insert on table "public"."friends_request" from "authenticated";

revoke references on table "public"."friends_request" from "authenticated";

revoke select on table "public"."friends_request" from "authenticated";

revoke trigger on table "public"."friends_request" from "authenticated";

revoke truncate on table "public"."friends_request" from "authenticated";

revoke update on table "public"."friends_request" from "authenticated";

revoke delete on table "public"."friends_request" from "service_role";

revoke insert on table "public"."friends_request" from "service_role";

revoke references on table "public"."friends_request" from "service_role";

revoke select on table "public"."friends_request" from "service_role";

revoke trigger on table "public"."friends_request" from "service_role";

revoke truncate on table "public"."friends_request" from "service_role";

revoke update on table "public"."friends_request" from "service_role";

revoke delete on table "public"."group" from "anon";

revoke insert on table "public"."group" from "anon";

revoke references on table "public"."group" from "anon";

revoke select on table "public"."group" from "anon";

revoke trigger on table "public"."group" from "anon";

revoke truncate on table "public"."group" from "anon";

revoke update on table "public"."group" from "anon";

revoke delete on table "public"."group" from "authenticated";

revoke insert on table "public"."group" from "authenticated";

revoke references on table "public"."group" from "authenticated";

revoke select on table "public"."group" from "authenticated";

revoke trigger on table "public"."group" from "authenticated";

revoke truncate on table "public"."group" from "authenticated";

revoke update on table "public"."group" from "authenticated";

revoke delete on table "public"."group" from "service_role";

revoke insert on table "public"."group" from "service_role";

revoke references on table "public"."group" from "service_role";

revoke select on table "public"."group" from "service_role";

revoke trigger on table "public"."group" from "service_role";

revoke truncate on table "public"."group" from "service_role";

revoke update on table "public"."group" from "service_role";

revoke delete on table "public"."group_profile" from "anon";

revoke insert on table "public"."group_profile" from "anon";

revoke references on table "public"."group_profile" from "anon";

revoke select on table "public"."group_profile" from "anon";

revoke trigger on table "public"."group_profile" from "anon";

revoke truncate on table "public"."group_profile" from "anon";

revoke update on table "public"."group_profile" from "anon";

revoke delete on table "public"."group_profile" from "authenticated";

revoke insert on table "public"."group_profile" from "authenticated";

revoke references on table "public"."group_profile" from "authenticated";

revoke select on table "public"."group_profile" from "authenticated";

revoke trigger on table "public"."group_profile" from "authenticated";

revoke truncate on table "public"."group_profile" from "authenticated";

revoke update on table "public"."group_profile" from "authenticated";

revoke delete on table "public"."group_profile" from "service_role";

revoke insert on table "public"."group_profile" from "service_role";

revoke references on table "public"."group_profile" from "service_role";

revoke select on table "public"."group_profile" from "service_role";

revoke trigger on table "public"."group_profile" from "service_role";

revoke truncate on table "public"."group_profile" from "service_role";

revoke update on table "public"."group_profile" from "service_role";

revoke delete on table "public"."notification_subscription" from "anon";

revoke insert on table "public"."notification_subscription" from "anon";

revoke references on table "public"."notification_subscription" from "anon";

revoke select on table "public"."notification_subscription" from "anon";

revoke trigger on table "public"."notification_subscription" from "anon";

revoke truncate on table "public"."notification_subscription" from "anon";

revoke update on table "public"."notification_subscription" from "anon";

revoke delete on table "public"."notification_subscription" from "authenticated";

revoke insert on table "public"."notification_subscription" from "authenticated";

revoke references on table "public"."notification_subscription" from "authenticated";

revoke select on table "public"."notification_subscription" from "authenticated";

revoke trigger on table "public"."notification_subscription" from "authenticated";

revoke truncate on table "public"."notification_subscription" from "authenticated";

revoke update on table "public"."notification_subscription" from "authenticated";

revoke delete on table "public"."notification_subscription" from "service_role";

revoke insert on table "public"."notification_subscription" from "service_role";

revoke references on table "public"."notification_subscription" from "service_role";

revoke select on table "public"."notification_subscription" from "service_role";

revoke trigger on table "public"."notification_subscription" from "service_role";

revoke truncate on table "public"."notification_subscription" from "service_role";

revoke update on table "public"."notification_subscription" from "service_role";

revoke delete on table "public"."post" from "anon";

revoke insert on table "public"."post" from "anon";

revoke references on table "public"."post" from "anon";

revoke select on table "public"."post" from "anon";

revoke trigger on table "public"."post" from "anon";

revoke truncate on table "public"."post" from "anon";

revoke update on table "public"."post" from "anon";

revoke delete on table "public"."post" from "authenticated";

revoke insert on table "public"."post" from "authenticated";

revoke references on table "public"."post" from "authenticated";

revoke select on table "public"."post" from "authenticated";

revoke trigger on table "public"."post" from "authenticated";

revoke truncate on table "public"."post" from "authenticated";

revoke update on table "public"."post" from "authenticated";

revoke delete on table "public"."post" from "service_role";

revoke insert on table "public"."post" from "service_role";

revoke references on table "public"."post" from "service_role";

revoke select on table "public"."post" from "service_role";

revoke trigger on table "public"."post" from "service_role";

revoke truncate on table "public"."post" from "service_role";

revoke update on table "public"."post" from "service_role";

revoke delete on table "public"."profile" from "anon";

revoke insert on table "public"."profile" from "anon";

revoke references on table "public"."profile" from "anon";

revoke select on table "public"."profile" from "anon";

revoke trigger on table "public"."profile" from "anon";

revoke truncate on table "public"."profile" from "anon";

revoke update on table "public"."profile" from "anon";

revoke delete on table "public"."profile" from "authenticated";

revoke insert on table "public"."profile" from "authenticated";

revoke references on table "public"."profile" from "authenticated";

revoke select on table "public"."profile" from "authenticated";

revoke trigger on table "public"."profile" from "authenticated";

revoke truncate on table "public"."profile" from "authenticated";

revoke update on table "public"."profile" from "authenticated";

revoke delete on table "public"."profile" from "service_role";

revoke insert on table "public"."profile" from "service_role";

revoke references on table "public"."profile" from "service_role";

revoke select on table "public"."profile" from "service_role";

revoke trigger on table "public"."profile" from "service_role";

revoke truncate on table "public"."profile" from "service_role";

revoke update on table "public"."profile" from "service_role";

revoke delete on table "public"."reporting" from "anon";

revoke insert on table "public"."reporting" from "anon";

revoke references on table "public"."reporting" from "anon";

revoke select on table "public"."reporting" from "anon";

revoke trigger on table "public"."reporting" from "anon";

revoke truncate on table "public"."reporting" from "anon";

revoke update on table "public"."reporting" from "anon";

revoke delete on table "public"."reporting" from "authenticated";

revoke insert on table "public"."reporting" from "authenticated";

revoke references on table "public"."reporting" from "authenticated";

revoke select on table "public"."reporting" from "authenticated";

revoke trigger on table "public"."reporting" from "authenticated";

revoke truncate on table "public"."reporting" from "authenticated";

revoke update on table "public"."reporting" from "authenticated";

revoke delete on table "public"."reporting" from "service_role";

revoke insert on table "public"."reporting" from "service_role";

revoke references on table "public"."reporting" from "service_role";

revoke select on table "public"."reporting" from "service_role";

revoke trigger on table "public"."reporting" from "service_role";

revoke truncate on table "public"."reporting" from "service_role";

revoke update on table "public"."reporting" from "service_role";

revoke delete on table "public"."suggested_challenge" from "anon";

revoke insert on table "public"."suggested_challenge" from "anon";

revoke references on table "public"."suggested_challenge" from "anon";

revoke select on table "public"."suggested_challenge" from "anon";

revoke trigger on table "public"."suggested_challenge" from "anon";

revoke truncate on table "public"."suggested_challenge" from "anon";

revoke update on table "public"."suggested_challenge" from "anon";

revoke delete on table "public"."suggested_challenge" from "authenticated";

revoke insert on table "public"."suggested_challenge" from "authenticated";

revoke references on table "public"."suggested_challenge" from "authenticated";

revoke select on table "public"."suggested_challenge" from "authenticated";

revoke trigger on table "public"."suggested_challenge" from "authenticated";

revoke truncate on table "public"."suggested_challenge" from "authenticated";

revoke update on table "public"."suggested_challenge" from "authenticated";

revoke delete on table "public"."suggested_challenge" from "service_role";

revoke insert on table "public"."suggested_challenge" from "service_role";

revoke references on table "public"."suggested_challenge" from "service_role";

revoke select on table "public"."suggested_challenge" from "service_role";

revoke trigger on table "public"."suggested_challenge" from "service_role";

revoke truncate on table "public"."suggested_challenge" from "service_role";

revoke update on table "public"."suggested_challenge" from "service_role";

revoke delete on table "public"."vote" from "anon";

revoke insert on table "public"."vote" from "anon";

revoke references on table "public"."vote" from "anon";

revoke select on table "public"."vote" from "anon";

revoke trigger on table "public"."vote" from "anon";

revoke truncate on table "public"."vote" from "anon";

revoke update on table "public"."vote" from "anon";

revoke delete on table "public"."vote" from "authenticated";

revoke insert on table "public"."vote" from "authenticated";

revoke references on table "public"."vote" from "authenticated";

revoke select on table "public"."vote" from "authenticated";

revoke trigger on table "public"."vote" from "authenticated";

revoke truncate on table "public"."vote" from "authenticated";

revoke update on table "public"."vote" from "authenticated";

revoke delete on table "public"."vote" from "service_role";

revoke insert on table "public"."vote" from "service_role";

revoke references on table "public"."vote" from "service_role";

revoke select on table "public"."vote" from "service_role";

revoke trigger on table "public"."vote" from "service_role";

revoke truncate on table "public"."vote" from "service_role";

revoke update on table "public"."vote" from "service_role";

alter table "public"."friends_request" alter column "id" set default extensions.uuid_generate_v4();

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.get_inactive_users(hours_inactive integer DEFAULT 24)
 RETURNS TABLE(id uuid, email character varying)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$BEGIN
  RETURN QUERY
  SELECT au.id, au.email::varchar
  FROM auth.users au
  WHERE au.last_sign_in_at < NOW() - (hours_inactive * INTERVAL '1 hour');
END;$function$
;

CREATE OR REPLACE FUNCTION public.cron_schedule()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE
    new_challenge RECORD;
BEGIN
    -- Désactiver le défi actuellement actif
    UPDATE challenge
    SET is_active = false
    WHERE is_active = true;

    -- Sélectionner un nouveau défi qui n'a pas encore été utilisé et l'activer
    UPDATE challenge
    SET is_active = true, 
        -- is_already_used = true,  
        date_used = CURRENT_DATE
    WHERE id = (
        SELECT id
        FROM challenge
        WHERE is_already_used = false
        ORDER BY RANDOM()
        LIMIT 1
    )
    RETURNING * INTO new_challenge;

    -- Appeler la fonction Edge avec les données du défi en utilisant PERFORM
    PERFORM http_post(
        'https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/sendChallengeNotification',
        json_build_object('title', new_challenge.title, 'message', new_challenge.description)::text,
        'application/json'
    );

    -- Log optionnel pour déboguer
    RAISE NOTICE 'Notification sent for new challenge: %', new_challenge.title;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_unique_invite_code()
 RETURNS text
 LANGUAGE plpgsql
AS $function$DECLARE
    new_code TEXT;
    exists BOOLEAN;
BEGIN
    LOOP
        -- Generate a random 10-character alphanumeric code
        new_code := upper(substring(md5(random()::text) from 1 for 10));

        -- Check if the code already exists in the "groups" table
        SELECT EXISTS (SELECT 1 FROM public.group WHERE invite_code = new_code) INTO exists;

        -- If the code is unique, exit the loop
        IF NOT exists THEN
            EXIT;
        END IF;
    END LOOP;

    RETURN new_code;
END;$function$
;

CREATE OR REPLACE FUNCTION public.get_group_by_invite_code(p_invite_code text)
 RETURNS SETOF "group"
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
begin
  -- Return the group that matches the invite code
  -- The security definer allows this function to bypass RLS
  return query
  select *
  from "group"
  where "group".invite_code = p_invite_code
  limit 1;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.get_group_ranking(group_id_param bigint)
 RETURNS TABLE(rank integer, profile_id uuid, username text, avatar_url text, winned_challenges integer)
 LANGUAGE sql
 STABLE
AS $function$
WITH challenge_winners AS (
  -- Find the winners for each challenge in the specified group with status "ended"
  SELECT
    p.profile_id,
    v.challenge_id
  FROM vote v
  JOIN post p ON v.post_id = p.id
  JOIN challenge c ON v.challenge_id = c.id  -- Ensure challenge belongs to the group
  WHERE c.group_id = group_id_param  -- ✅ Only count challenges in this group
    AND c.status = 'ended'  -- ✅ Only consider challenges that are "ended"
  GROUP BY v.challenge_id, p.profile_id
  HAVING COUNT(v.id) = (
    -- Select the max votes received in each challenge
    SELECT MAX(vote_count)
    FROM (
      SELECT p.profile_id, v.challenge_id, COUNT(v.id) AS vote_count
      FROM vote v
      JOIN post p ON v.post_id = p.id
      JOIN challenge c ON v.challenge_id = c.id  -- Ensure challenge belongs to the group
      WHERE p.challenge_id = v.challenge_id
        AND c.status = 'ended'  -- ✅ Only count votes from ended challenges
      GROUP BY p.profile_id, v.challenge_id
    ) AS max_votes
    WHERE max_votes.challenge_id = v.challenge_id
  )
),
user_wins AS (
  -- Count the number of challenges won per user (only in this group)
  SELECT profile_id, COUNT(challenge_id) AS winned_challenges
  FROM challenge_winners
  GROUP BY profile_id
),
group_users AS (
  -- Get all users in the specified group
  SELECT gp.profile_id, pr.username, pr.avatar_url
  FROM group_profile gp
  JOIN profile pr ON gp.profile_id = pr.id
  WHERE gp.group_id = group_id_param
)
-- Generate the final ranking table
SELECT 
  ROW_NUMBER() OVER (ORDER BY COALESCE(uw.winned_challenges, 0) DESC) AS rank,
  gu.profile_id,
  gu.username,
  gu.avatar_url,
  COALESCE(uw.winned_challenges, 0) AS winned_challenges
FROM group_users gu
LEFT JOIN user_wins uw ON gu.profile_id = uw.profile_id
ORDER BY winned_challenges DESC;
$function$
;

CREATE OR REPLACE FUNCTION public.get_group_user_count(group_id_param bigint)
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
DECLARE
    user_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO user_count
    FROM group_profile
    WHERE group_id = group_id_param;
    
    RETURN user_count;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_latest_challenge_status(group_ids bigint[])
 RETURNS TABLE(group_id bigint, status challenge_status)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  WITH latest_challenges AS (
    SELECT 
      c.group_id,  -- Fully qualify the column
      c.status,
      ROW_NUMBER() OVER (PARTITION BY c.group_id ORDER BY c.created_at DESC) AS rn
    FROM 
      challenge c  -- Alias the table to avoid ambiguity
    WHERE 
      c.group_id = ANY(group_ids)
  )
  SELECT 
    lc.group_id,  -- Fully qualify the column
    lc.status
  FROM 
    latest_challenges lc  -- Alias the CTE to avoid ambiguity
  WHERE 
    lc.rn = 1;  -- Fully qualify the rn column
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.profile (id, email, username, birthdate)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'username',
    NEW.raw_user_meta_data->>'birthdate'
  );
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.insert_derkap_with_users(p_challenge text, p_caption text, p_allowed_users uuid[], p_base_key text, p_file_path text, p_user_id uuid)
 RETURNS TABLE(derkap_id bigint)
 LANGUAGE plpgsql
AS $function$
declare
    v_derkap_id bigint;
begin
    -- Insert into the 'derkap' table
    insert into public.derkap(challenge, creator_id, file_path, caption, base_key)
    values (p_challenge, p_user_id, p_file_path, p_caption, p_base_key)
    returning id into v_derkap_id;

    -- Insert allowed users into 'derkap_allowed_users' table
    insert into public.derkap_allowed_users(derkap_id, allowed_user_id)
    select v_derkap_id, unnest(p_allowed_users);

    -- Return the inserted derkap ID
    return query select v_derkap_id;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.insert_derkap_with_users(p_challenge text, p_encrypted_post bytea, p_caption text, p_allowed_users uuid[], p_base_key text, p_file_path text, p_user_id uuid)
 RETURNS TABLE(derkap_id bigint)
 LANGUAGE plpgsql
AS $function$
declare
    v_derkap_id bigint;
begin
    -- Insert into the 'derkap' table
    insert into public.derkap(challenge, creator_id, file_path, caption, base_key)
    values (p_challenge, p_user_id, p_file_path, p_caption, p_base_key)
    returning id into v_derkap_id;

    -- Insert allowed users into 'derkap_allowed_users' table
    insert into public.derkap_allowed_users(derkap_id, allowed_user_id)
    select v_derkap_id, unnest(p_allowed_users);

    -- Return the inserted derkap ID
    return query select v_derkap_id;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.is_derkap_accessible(target_derkap_id bigint, requesting_user_id uuid)
 RETURNS boolean
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT EXISTS (
    -- Check if the user is the creator
    SELECT 1
    FROM public.derkap
    WHERE id = target_derkap_id AND creator_id = requesting_user_id
  ) OR EXISTS (
    -- Check if the user is in the allowed list
    SELECT 1
    FROM public.derkap_allowed_users
    WHERE derkap_id = target_derkap_id AND allowed_user_id = requesting_user_id
  );
$function$
;

CREATE OR REPLACE FUNCTION public.notify_backend_of_new_challenge()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF NEW.is_active = true AND NEW.notification_sent = false THEN
        -- Appelle une fonction externe (que nous allons configurer dans Supabase) pour notifier le backend
        PERFORM pg_notify('new_challenge', json_build_object(
            'title', NEW.title, 
            'description', NEW.description
        )::text);

        -- Marque la notification comme envoyée
        NEW.notification_sent := true;
    END IF;

    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.notify_challenge_update()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Determine if this is a new challenge or a status update
  IF TG_OP = 'INSERT' THEN
    PERFORM
      net.http_post(
        url := 'https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/notify-challenge-update',
        headers := json_build_object('Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhya3R4cXBzcWJqbm9ja2dnbmljIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNzc0ODMxOSwiZXhwIjoyMDMzMzI0MzE5fQ.eT0_E89SJcXMMxwiQBxr0IwIhASgms4BDNRVz3CZ_xc')::jsonb,
        body := json_build_object(
          'challenge_id', NEW.id,
          'group_id', NEW.group_id,
          'event_type', 'new_challenge',
          'new_status', NEW.status
        )::jsonb
      );
  ELSIF TG_OP = 'UPDATE' AND OLD.status <> NEW.status THEN
    PERFORM
      net.http_post(
        url := 'https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/notify-challenge-update',
        headers := json_build_object('Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhya3R4cXBzcWJqbm9ja2dnbmljIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNzc0ODMxOSwiZXhwIjoyMDMzMzI0MzE5fQ.eT0_E89SJcXMMxwiQBxr0IwIhASgms4BDNRVz3CZ_xc')::jsonb,
        body := json_build_object(
          'challenge_id', NEW.id,
          'group_id', NEW.group_id,
          'event_type', 'status_change',
          'old_status', OLD.status,
          'new_status', NEW.status
        )::jsonb
      );
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.notify_new_encrypted_post()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  PERFORM
    net.http_post(
      url := 'https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/notify-new-post',
      headers := json_build_object(
        'Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhya3R4cXBzcWJqbm9ja2dnbmljIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNzc0ODMxOSwiZXhwIjoyMDMzMzI0MzE5fQ.eT0_E89SJcXMMxwiQBxr0IwIhASgms4BDNRVz3CZ_xc'
      )::jsonb,
      body := json_build_object(
        'post_id', NEW.id,
        'challenge_id', NEW.challenge_id,
        'sender_id', NEW.profile_id
      )::jsonb
    );

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.notify_new_group_member()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  PERFORM net.http_post(
    url := 'https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/notify-new-group-member',
    headers := json_build_object(
      'Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhya3R4cXBzcWJqbm9ja2dnbmljIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNzc0ODMxOSwiZXhwIjoyMDMzMzI0MzE5fQ.eT0_E89SJcXMMxwiQBxr0IwIhASgms4BDNRVz3CZ_xc'
    )::jsonb,
    body := json_build_object(
      'group_id', NEW.group_id,
      'sender_id', NEW.profile_id
    )::jsonb
  );

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.notify_new_post()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$BEGIN
  PERFORM
    net.http_post(
      url := 'https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/notify-new-post',
      headers := json_build_object(
        'Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhya3R4cXBzcWJqbm9ja2dnbmljIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTcxNzc0ODMxOSwiZXhwIjoyMDMzMzI0MzE5fQ.eT0_E89SJcXMMxwiQBxr0IwIhASgms4BDNRVz3CZ_xc'
      )::jsonb,
      body := json_build_object(
        'allowed_user_id', NEW.allowed_user_id
        'derkap_id', NEW.derkap_id
      )::jsonb
    );

  RETURN NEW;
END;$function$
;

CREATE OR REPLACE FUNCTION public.search_users_friendship_status(p_search_username text, p_current_user_id uuid)
 RETURNS TABLE(id uuid, username text, avatar_url text, email text, friendship_status friendship_status_type, friend_request_id uuid)
 LANGUAGE plpgsql
AS $function$
begin
  return query
  with friendship_status as (
    select 
      case
        when fr.status = 'accepted' then 'friend'::friendship_status_type
        when fr.sender_id = p_current_user_id and fr.status = 'pending' then 'pending_their_acceptance'::friendship_status_type
        when fr.receiver_id = p_current_user_id and fr.status = 'pending' then 'pending_your_acceptance'::friendship_status_type
        else 'not_friend'::friendship_status_type
      end as status,
      case 
        when fr.sender_id = p_current_user_id then fr.receiver_id
        else fr.sender_id
      end as other_user_id,
      fr.id as request_id
    from friends_request fr
    where (fr.sender_id = p_current_user_id or fr.receiver_id = p_current_user_id)
  )
  select 
    p.id,
    p.username,
    p.avatar_url,
    p.email,
    coalesce(fs.status, 'not_friend'::friendship_status_type) as friendship_status,
    fs.request_id as friend_request_id
  from profile p
  left join friendship_status fs on p.id = fs.other_user_id
  where 
    p.username ilike '%' || p_search_username || '%'
    and p.id != p_current_user_id
  order by 
    p.username;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.set_invite_code()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$BEGIN
    -- If invite_code is not provided, generate a new one
    IF NEW.invite_code IS NULL THEN
        NEW.invite_code := generate_unique_invite_code();
    END IF;

    RETURN NEW;
END;$function$
;

CREATE OR REPLACE FUNCTION public.update_challenge_status_to_ended()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
  challenge_group_id BIGINT;
  member_count INTEGER;
  vote_count INTEGER;
  current_status text;
BEGIN
  -- Get the group ID and current status of the challenge
  SELECT c.group_id, c.status::text INTO challenge_group_id, current_status
  FROM challenge c
  WHERE c.id = NEW.challenge_id;

  -- Count the number of active members in the group
  SELECT COUNT(*) INTO member_count
  FROM group_profile gp
  WHERE gp.group_id = challenge_group_id
  AND gp.profile_id IS NOT NULL;

  -- Count the number of DISTINCT voters for this challenge
  SELECT COUNT(DISTINCT v.user_id) INTO vote_count
  FROM vote v
  WHERE v.challenge_id = NEW.challenge_id;

  -- If the vote count equals the member count, update the challenge status to 'ended'
  IF vote_count >= member_count THEN
    UPDATE challenge
    SET status = 'ended'::challenge_status
    WHERE id = NEW.challenge_id
    AND status = 'voting'::challenge_status;
    
  END IF;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_challenge_status_to_voting()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- Get the challenge and its associated group information
    WITH challenge_info AS (
        SELECT 
            c.id AS challenge_id,
            c.group_id,
            c.status,
            (
                SELECT COUNT(*)
                FROM group_profile gp
                WHERE gp.group_id = c.group_id
            ) AS total_members,
            (
                SELECT COUNT(DISTINCT p.profile_id)
                FROM post p
                WHERE p.challenge_id = c.id
            ) AS total_posts
        FROM challenge c
        WHERE c.id = NEW.challenge_id
    )
    UPDATE challenge c
    SET status = 'voting'
    FROM challenge_info ci
    WHERE c.id = ci.challenge_id
    AND ci.status != 'voting'  -- Only update if not already in voting status
    AND ci.total_posts = ci.total_members;  -- Update only when all members have posted

    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_last_activity_on_challenge_change()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  update "group"
  set last_activity = now()
  where id = new.group_id;
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_last_activity_on_group_profile_change()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  update "group"
  set last_activity = now()
  where id = coalesce(new.group_id, old.group_id);
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_last_activity_on_group_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.last_activity = now();
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_last_activity_on_post_change()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  update "group"
  set last_activity = now()
  where id = (
    select group_id from challenge where id = coalesce(new.challenge_id, old.challenge_id)
  );
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_last_activity_on_vote_change()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  update "group"
  set last_activity = now()
  where id = (
    select group_id 
    from challenge 
    where id = new.challenge_id
  );
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;

CREATE TRIGGER webhook_notify_new_comment AFTER INSERT ON public.comment FOR EACH ROW EXECUTE FUNCTION supabase_functions.http_request('https://hrktxqpsqbjnockggnic.supabase.co/functions/v1/notify-new-comment', 'POST', '{"Content-type":"application/json","Authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhya3R4cXBzcWJqbm9ja2dnbmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTc3NDgzMTksImV4cCI6MjAzMzMyNDMxOX0.vnNh1kwokAi43XuAArlkyhlAFxDuKVzYkPKOvnOoRp4"}', '{}', '5000');


